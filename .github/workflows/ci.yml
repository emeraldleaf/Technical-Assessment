name: SignalBooster MVP - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggers

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  test:
    name: ğŸ§ª Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Cache NuGet Packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: ğŸ” Verify Test Data
      working-directory: tests
      run: |
        echo "ğŸ“Š Test Infrastructure Verification"
        echo "Input files: $(find test_notes -name "*.txt" -o -name "*.json" | wc -l)"
        echo "Expected files: $(find test_outputs -name "*_expected.json" | wc -l)"
        echo "ğŸ“ Test directories:"
        ls -la test_notes/ test_outputs/ | head -20
        
    - name: ğŸš€ Run Integration Test Suite
      working-directory: tests
      run: |
        echo "ğŸ§ª Executing comprehensive integration tests..."
        chmod +x run-integration-tests.sh
        ./run-integration-tests.sh --verbose
        
    - name: ğŸ“Š Upload Test Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: tests/test-report.md
        
    - name: ğŸ“‹ Upload Test Outputs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-outputs
        path: tests/test_outputs/*_actual.json

  build:
    name: ğŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore Dependencies
      working-directory: src
      run: dotnet restore SignalBooster.Mvp.csproj
      
    - name: ğŸ”¨ Build Application
      working-directory: src
      run: dotnet build SignalBooster.Mvp.csproj --configuration Release --no-restore
      
    - name: ğŸ“¦ Publish Application
      working-directory: src
      run: |
        dotnet publish SignalBooster.Mvp.csproj \
          --configuration Release \
          --output ./publish \
          --no-build \
          --self-contained false
          
    - name: ğŸ“ Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: signalbooster-mvp
        path: src/publish/

  quality-gates:
    name: ğŸ›¡ï¸ Quality Gates
    runs-on: ubuntu-latest
    needs: [test, build]
    
    steps:
    - name: ğŸ“ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ” Code Analysis
      working-directory: src
      run: |
        echo "ğŸ” Running static code analysis..."
        dotnet build SignalBooster.Mvp.csproj --verbosity normal | tee build-warnings.log
        
        # Check for warnings
        if grep -q "warning" build-warnings.log; then
          echo "âš ï¸ Build warnings detected:"
          grep "warning" build-warnings.log
        else
          echo "âœ… No build warnings found"
        fi
        
    - name: ğŸ“ˆ Test Coverage Analysis
      working-directory: tests
      run: |
        echo "ğŸ“ˆ Analyzing test coverage..."
        dotnet test SignalBooster.Mvp.Tests.csproj \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage \
          --verbosity minimal
          
    - name: ğŸ† Quality Summary
      run: |
        echo "ğŸ† Quality Gates Summary"
        echo "âœ… Integration tests: PASSED"
        echo "âœ… Build: SUCCESS"
        echo "âœ… Code analysis: COMPLETED"
        echo "ğŸ“Š Coverage analysis: COMPLETED"

  deployment-readiness:
    name: ğŸš€ Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [test, build, quality-gates]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“ Download Build Artifacts
      uses: actions/download-artifact@v3
      with:
        name: signalbooster-mvp
        path: ./artifacts
        
    - name: ğŸ“‹ Download Test Report
      uses: actions/download-artifact@v3
      with:
        name: test-report
        path: ./reports
        
    - name: âœ… Deployment Readiness Verification
      run: |
        echo "ğŸš€ SignalBooster MVP - Deployment Readiness Check"
        echo ""
        echo "ğŸ“¦ Build Artifacts:"
        ls -la ./artifacts/
        echo ""
        echo "ğŸ“Š Test Results:"
        cat ./reports/test-report.md
        echo ""
        echo "âœ… All quality gates passed - Ready for deployment!"
        
    - name: ğŸ‰ Success Notification
      run: |
        echo "ğŸ‰ CI/CD Pipeline Completed Successfully!"
        echo ""
        echo "âœ… Integration Tests: PASSED"
        echo "âœ… Build: SUCCESS" 
        echo "âœ… Quality Gates: PASSED"
        echo "âœ… Deployment Ready: YES"
        echo ""
        echo "ğŸš€ SignalBooster MVP is production-ready!"